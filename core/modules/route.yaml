# Route module - manages API routing rules
module: route

schema:
  # Identity
  name:           { type: string, required: true, lookup: true, description: "Unique name identifying this route" }
  description:    { type: string, default: "", description: "Human-readable description of this route's purpose" }

  # Matching criteria
  path_pattern:   { type: string, required: true, description: "URL path pattern to match incoming requests" }
  match_type:     { type: enum, values: [exact, prefix, regex], default: prefix, description: "How path_pattern is matched: exact, prefix, or regex" }
  methods:        { type: json, description: "HTTP methods to match (empty array matches all methods)" }
  headers:        { type: json, description: "Header conditions that must match for this route" }

  # Host matching (for multi-tenant/subdomain routing)
  host_pattern:   { type: string, default: "", description: "Host pattern for matching (e.g., api.example.com, *.apps.localhost)" }
  host_match_type: { type: enum, values: ["", exact, wildcard, regex], default: "", description: "How host_pattern is matched: exact, wildcard, or regex (empty = no host matching)" }

  # Target configuration
  upstream_id:    { type: ref, to: upstream, required: true, description: "Backend service to forward matching requests to" }
  path_rewrite:   { type: string, description: "Expression to transform the request path before forwarding" }
  method_override: { type: string, description: "Override the HTTP method when forwarding to upstream" }

  # Transformations (JSON objects)
  request_transform:  { type: json, description: "Rules to transform request headers and body" }
  response_transform: { type: json, description: "Rules to transform response headers and body" }

  # Metering
  metering_expr:  { type: string, default: "1", description: "Expression to calculate request cost for rate limiting" }
  metering_mode:  { type: enum, values: [request, response_field, bytes, custom], default: request, description: "How API usage is measured for billing" }

  # Protocol behavior
  protocol:       { type: enum, values: [http, http_stream, sse, websocket], default: http, description: "Protocol handling mode for this route" }

  # Priority and state
  priority:       { type: int, default: 0, description: "Route matching priority (higher values match first)" }
  enabled:        { type: bool, default: true, description: "Whether this route is active and processing requests" }

actions:
  enable:
    set: { enabled: true }
    description: Enable a route

  disable:
    set: { enabled: false }
    description: Disable a route

  set_priority:
    input:
      - { name: priority, type: int, required: true }
    description: Set route priority

channels:
  http:
    serve:
      enabled: true
      base_path: /api/routes
      endpoints:
        - { action: list, method: GET, path: "/" }
        - { action: get, method: GET, path: "/{id}" }
        - { action: create, method: POST, path: "/", auth: admin }
        - { action: update, method: PATCH, path: "/{id}", auth: admin }
        - { action: delete, method: DELETE, path: "/{id}", auth: admin }
        - { action: enable, method: POST, path: "/{id}/enable", auth: admin }
        - { action: disable, method: POST, path: "/{id}/disable", auth: admin }

  cli:
    serve:
      enabled: true
      command: routes
      commands:
        - action: list
          columns: [id, name, path_pattern, match_type, upstream_id, priority, enabled]
        - action: get
          args:
            - { name: id, required: true }
        - action: create
          flags:
            - { param: name, required: true }
            - { param: path_pattern, name: path, short: p, required: true }
            - { param: upstream_id, name: upstream, short: u, required: true }
            - { param: match_type, name: match, default: prefix }
            - { param: methods, description: "Comma-separated list of methods" }
            - { param: host_pattern, name: host, short: H, description: "Host pattern (e.g., *.apps.localhost)" }
            - { param: host_match_type, name: host-match, description: "Host match type: exact, wildcard, regex" }
            - { param: protocol, default: http }
            - { param: priority, type: int, default: "0" }
        - action: update
          args:
            - { name: id, required: true }
          flags:
            - { param: name }
            - { param: path_pattern, name: path }
            - { param: upstream_id, name: upstream }
            - { param: host_pattern, name: host, short: H, description: "Host pattern (e.g., *.apps.localhost)" }
            - { param: host_match_type, name: host-match, description: "Host match type: exact, wildcard, regex" }
            - { param: priority, type: int }
        - action: delete
          args:
            - { name: id, required: true }
          confirm: "Are you sure you want to delete this route?"
        - action: enable
          args:
            - { name: id, required: true }
        - action: disable
          args:
            - { name: id, required: true }

hooks:
  # Notify router to reload after changes
  after_create:
    - emit: route.created
    - call: reload_router

  after_update:
    - emit: route.updated
    - call: reload_router

  after_delete:
    - emit: route.deleted
    - call: reload_router

meta:
  description: API routing rules mapping paths to upstreams
  icon: git-branch
  display_name: Routes
  plural: Routes
