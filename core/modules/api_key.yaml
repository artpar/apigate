# API Key module - manages API authentication keys
module: api_key

schema:
  # Ownership (either user_id or group_id must be set)
  user_id:    { type: ref, to: user, description: "The user who owns this API key (for personal keys)" }
  group_id:   { type: ref, to: group, description: "The group that owns this API key (for shared keys)" }
  created_by: { type: ref, to: user, description: "The user who created this key (for audit)" }

  # Key data
  hash:       { type: secret, internal: true, description: "Cryptographic hash of the API key" }
  prefix:     { type: string, lookup: true, immutable: true, description: "Visible key prefix for identification (e.g., ak_xxxxx)" }
  name:       { type: string, default: "", description: "Human-readable label for this key" }
  scopes:     { type: json, description: "Array of permission scopes granted to this key" }
  quota_bypass: { type: bool, default: false, description: "Service account: bypass quota limits for admin/infrastructure operations" }

  # Lifecycle (internal - managed by system)
  expires_at: { type: timestamp, description: "When this key expires and becomes invalid" }
  revoked_at: { type: timestamp, internal: true, description: "When this key was manually revoked" }
  last_used:  { type: timestamp, internal: true, description: "Timestamp of most recent API call with this key" }

actions:
  # List keys for a user
  list_by_user:
    input:
      - { name: user_id, type: ref, to: user, required: true }
    description: List all personal API keys for a user

  # List keys for a group
  list_by_group:
    input:
      - { name: group_id, type: ref, to: group, required: true }
    description: List all API keys for a group

  # Revoke a key
  revoke:
    set: { revoked_at: "${NOW}" }
    description: Revoke an API key
    confirm: true

  # Refresh last used timestamp
  touch:
    set: { last_used: "${NOW}" }
    description: Update last used timestamp
    internal: true

channels:
  http:
    serve:
      enabled: true
      base_path: /api/keys
      endpoints:
        - { action: list, method: GET, path: "/", auth: admin }
        - { action: list_by_user, method: GET, path: "/user/{user_id}" }
        - { action: list_by_group, method: GET, path: "/group/{group_id}" }
        - { action: get, method: GET, path: "/{id}" }
        - { action: create, method: POST, path: "/" }
        - { action: delete, method: DELETE, path: "/{id}" }
        - { action: revoke, method: POST, path: "/{id}/revoke" }

  cli:
    serve:
      enabled: true
      command: keys
      commands:
        - action: list
          columns: [id, user_id, group_id, prefix, name, expires_at, revoked_at, last_used, created_at]
        - action: list_by_user
          name: list-user
          flags:
            - { param: user_id, name: user, short: u, required: true }
          columns: [id, prefix, name, expires_at, revoked_at, last_used]
        - action: list_by_group
          name: list-group
          flags:
            - { param: group_id, name: group, short: g, required: true }
          columns: [id, prefix, name, created_by, expires_at, revoked_at, last_used]
        - action: get
          args:
            - { name: id, required: true }
        - action: create
          flags:
            - { param: user_id, name: user, short: u, description: "User ID (for personal keys)" }
            - { param: group_id, name: group, short: g, description: "Group ID (for shared keys)" }
            - { param: name, short: n }
            - { param: scopes, description: "Comma-separated list of scopes" }
            - { param: expires_at, name: expires, description: "Expiration time (RFC3339)" }
            - { param: quota_bypass, name: quota-bypass, description: "Service account: bypass quota limits" }
        - action: delete
          args:
            - { name: id, required: true }
          confirm: "Are you sure you want to delete this API key?"
        - action: revoke
          args:
            - { name: id, required: true }

hooks:
  # After key creation, return the raw key (only time it's visible)
  after_create:
    - emit: key.created

  # After revocation, notify
  after_revoke:
    - emit: key.revoked

meta:
  description: API keys for authenticating API requests
  icon: key
  display_name: API Keys
  plural: API Keys
