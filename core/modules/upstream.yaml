# Upstream module - manages backend service configurations
module: upstream

schema:
  # Identity
  name:             { type: string, required: true, lookup: true, description: "Unique name identifying this upstream service" }
  description:      { type: string, default: "", description: "Human-readable description of this backend service" }

  # Target
  base_url:         { type: string, required: true, description: "Base URL of the backend service (e.g., https://api.example.com)" }
  timeout_ms:       { type: int, default: 30000, description: "Request timeout in milliseconds" }

  # Connection pooling
  max_idle_conns:   { type: int, default: 100, description: "Maximum number of idle connections to maintain" }
  idle_conn_timeout_ms: { type: int, default: 90000, description: "How long idle connections are kept alive in milliseconds" }

  # Authentication injection
  auth_type:        { type: enum, values: [none, header, bearer, basic], default: none, description: "Type of authentication to inject into upstream requests" }
  auth_header:      { type: string, default: "", description: "Custom header name for authentication (when auth_type is header)" }
  auth_value_encrypted: { type: bytes, default: null, description: "Encrypted authentication credentials" }

  # State
  enabled:          { type: bool, default: true, description: "Whether this upstream is available for routing" }

actions:
  enable:
    set: { enabled: true }
    description: Enable an upstream

  disable:
    set: { enabled: false }
    description: Disable an upstream

  health_check:
    description: Check if the upstream is reachable
    internal: false

  set_auth:
    input:
      - { name: auth_type, type: enum, values: [none, header, bearer, basic], required: true }
      - { name: auth_header, type: string }
      - { name: auth_value, type: secret, prompt: true }
    description: Configure upstream authentication

channels:
  http:
    serve:
      enabled: true
      base_path: /api/upstreams
      endpoints:
        - { action: list, method: GET, path: "/" }
        - { action: get, method: GET, path: "/{id}" }
        - { action: create, method: POST, path: "/", auth: admin }
        - { action: update, method: PATCH, path: "/{id}", auth: admin }
        - { action: delete, method: DELETE, path: "/{id}", auth: admin }
        - { action: enable, method: POST, path: "/{id}/enable", auth: admin }
        - { action: disable, method: POST, path: "/{id}/disable", auth: admin }
        - { action: health_check, method: GET, path: "/{id}/health" }

  cli:
    serve:
      enabled: true
      command: upstreams
      commands:
        - action: list
          columns: [id, name, base_url, auth_type, enabled]
        - action: get
          args:
            - { name: id, required: true }
        - action: create
          flags:
            - { param: name, required: true }
            - { param: base_url, name: url, short: u, required: true }
            - { param: timeout_ms, name: timeout, type: int, default: "30000" }
            - { param: auth_type, name: auth, default: none }
            - { param: auth_header }
            - { param: auth_value, prompt: true }
        - action: update
          args:
            - { name: id, required: true }
          flags:
            - { param: name }
            - { param: base_url, name: url }
            - { param: timeout_ms, name: timeout, type: int }
        - action: delete
          args:
            - { name: id, required: true }
          confirm: "Are you sure you want to delete this upstream? Routes using it will stop working."
        - action: enable
          args:
            - { name: id, required: true }
        - action: disable
          args:
            - { name: id, required: true }
        - action: health_check
          name: health
          args:
            - { name: id, required: true }

hooks:
  # Notify when upstreams change
  after_create:
    - emit: upstream.created

  after_update:
    - emit: upstream.updated
    - call: reload_router

  after_delete:
    - emit: upstream.deleted
    - call: reload_router

meta:
  description: Backend services that routes forward requests to
  icon: server
  display_name: Upstreams
  plural: Upstreams
