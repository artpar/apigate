# Plan module - manages pricing tiers
module: plan

schema:
  # Identity
  name:               { type: string, required: true, lookup: true, description: "Unique name identifying this pricing plan" }
  description:        { type: string, default: "", description: "Human-readable description of plan features" }

  # Rate limiting
  rate_limit_per_minute: { type: int, default: 60, description: "Maximum API requests allowed per minute" }
  requests_per_month:    { type: int, default: 1000, description: "Total API requests included per billing cycle" }

  # Pricing (all values in cents)
  price_monthly:      { type: int, default: 0, description: "Monthly subscription price in cents" }
  overage_price:      { type: int, default: 0, description: "Price per additional request beyond quota in cents" }

  # Payment provider IDs
  stripe_price_id:    { type: string, description: "Stripe Price ID for subscription billing" }
  paddle_price_id:    { type: string, description: "Paddle Price ID for subscription billing" }
  lemon_variant_id:   { type: string, description: "LemonSqueezy variant ID for subscription billing" }

  # Plan state
  is_default:         { type: bool, default: false, description: "Whether this plan is assigned to new users" }
  enabled:            { type: bool, default: true, description: "Whether this plan is available for selection" }

actions:
  enable:
    set: { enabled: true }
    description: Enable a pricing plan

  disable:
    set: { enabled: false }
    description: Disable a pricing plan
    confirm: true

  set_default:
    set: { is_default: true }
    description: Set as the default plan for new users
    # Note: Should clear is_default on other plans (handled by hook)

channels:
  http:
    serve:
      enabled: true
      base_path: /api/plans
      endpoints:
        - { action: list, method: GET, path: "/" }
        - { action: get, method: GET, path: "/{id}" }
        - { action: create, method: POST, path: "/", auth: admin }
        - { action: update, method: PATCH, path: "/{id}", auth: admin }
        - { action: delete, method: DELETE, path: "/{id}", auth: admin }
        - { action: enable, method: POST, path: "/{id}/enable", auth: admin }
        - { action: disable, method: POST, path: "/{id}/disable", auth: admin }
        - { action: set_default, method: POST, path: "/{id}/set-default", auth: admin }

    consume:
      # Stripe price management
      stripe:
        base: https://api.stripe.com/v1
        auth:
          type: bearer
          bearer: ${STRIPE_SECRET_KEY}
        methods:
          create_price:
            method: POST
            path: /prices
            map:
              unit_amount: price_monthly
              currency: usd
              recurring[interval]: month
              product_data[name]: name
            response:
              set:
                stripe_price_id: id
          update_price:
            method: POST
            path: /prices/{stripe_price_id}
            map:
              active: enabled

  cli:
    serve:
      enabled: true
      command: plans
      commands:
        - action: list
          columns: [id, name, rate_limit_per_minute, requests_per_month, price_monthly, is_default, enabled]
        - action: get
          args:
            - { name: id, required: true, description: "Plan ID" }
        - action: create
          flags:
            - { param: name, required: true }
            - { param: description }
            - { param: rate_limit_per_minute, type: int, default: "60" }
            - { param: requests_per_month, type: int, default: "1000" }
            - { param: price_monthly, type: int, default: "0" }
            - { param: overage_price, type: int, default: "0" }
            - { param: is_default, type: bool, default: "false" }
        - action: delete
          args:
            - { name: id, required: true }
          confirm: "Are you sure you want to delete this plan? Users on this plan will need to be migrated."
        - action: enable
          args:
            - { name: id, required: true }
        - action: disable
          args:
            - { name: id, required: true }
        - action: set_default
          args:
            - { name: id, required: true }

hooks:
  # When setting a new default, clear is_default on other plans
  before_set_default:
    - call: clear_other_defaults

  # Sync to payment provider when plan changes, then reload plans into proxy
  after_create:
    - call: sync_to_stripe
    - call: reload_plans

  after_update:
    - call: sync_to_stripe
    - call: reload_plans

  after_delete:
    - call: reload_plans

meta:
  description: Pricing plans with rate limits and billing
  icon: credit-card
  display_name: Plans
  plural: Plans
