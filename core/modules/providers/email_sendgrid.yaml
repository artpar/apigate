# SendGrid Email Provider Module
# Implements the email capability using SendGrid API
module: email_sendgrid

meta:
  description: SendGrid email integration for transactional emails
  implements: [email]
  icon: mail
  display_name: SendGrid

schema:
  enabled:    { type: bool, default: false, description: "Whether SendGrid is the active email provider" }
  api_key:    { type: secret, required: true, description: "SendGrid API key" }
  from_email: { type: email, required: true, description: "Default sender email address" }
  from_name:  { type: string, description: "Default sender display name" }

actions:
  test_connection:
    description: Verify SendGrid API key is valid
    # Implementation calls GET /v3/user/profile

  send:
    description: Send a single email
    input:
      - { name: to, type: email, required: true }
      - { name: subject, type: string, required: true }
      - { name: body_html, type: string }
      - { name: body_text, type: string }
      - { name: from_email, type: email }
      - { name: from_name, type: string }
      - { name: reply_to, type: email }

  send_template:
    description: Send email using a SendGrid dynamic template
    input:
      - { name: to, type: email, required: true }
      - { name: template_id, type: string, required: true, description: "SendGrid template ID (d-xxxxx)" }
      - { name: variables, type: json, description: "Dynamic template data" }
      - { name: from_email, type: email }
      - { name: from_name, type: string }

  send_bulk:
    description: Send to multiple recipients using personalizations
    input:
      - { name: recipients, type: json, required: true }
      - { name: subject, type: string, required: true }
      - { name: body_html, type: string }
      - { name: body_text, type: string }

channels:
  http:
    consume:
      sendgrid:
        base: https://api.sendgrid.com
        auth:
          type: bearer
          bearer: ${self.api_key}
        methods:
          send_mail:
            method: POST
            path: /v3/mail/send
          get_profile:
            method: GET
            path: /v3/user/profile

  cli:
    serve:
      enabled: true
      command: email
      commands:
        - action: test_connection
        - action: send
          flags:
            - { param: to, required: true }
            - { param: subject, required: true }
            - { param: body_text }

hooks:
  after_send:
    - emit: email.sent
