{{define "content"}}
<div class="page">
    <div class="page-header">
        <h1 class="page-title">API Keys</h1>
        <button onclick="document.getElementById('create-key-modal').classList.remove('hidden')" class="btn btn-primary">Create Key</button>
    </div>

    <p class="page-desc">API keys authenticate requests to your gateway. Each key is tied to a user and inherits their plan limits.</p>

    <div class="card">
        <div class="card-body flush" id="keys-table" hx-get="/partials/keys" hx-trigger="load" hx-swap="innerHTML">
            <div class="table-empty">Loading keys...</div>
        </div>
    </div>
</div>

<!-- Create Key Modal -->
<div id="create-key-modal" class="modal hidden">
    <div class="modal-content">
        <div class="modal-header">
            <h3 class="modal-title">Create API Key</h3>
        </div>
        <div class="modal-body">
            <form action="/keys" method="POST" class="form">
                <div class="form-group">
                    <label for="user_id" class="form-label">User</label>
                    <select id="user_id" name="user_id" required class="form-input">
                        {{range .Users}}
                        <option value="{{.ID}}">{{.Email}}</option>
                        {{end}}
                    </select>
                </div>
                <div class="form-group">
                    <label for="name" class="form-label">Key Name (optional)</label>
                    <input type="text" id="name" name="name" class="form-input" placeholder="Production API Key">
                </div>
                <div class="form-actions">
                    <button type="button" onclick="document.getElementById('create-key-modal').classList.add('hidden')" class="btn btn-secondary">Cancel</button>
                    <button type="submit" class="btn btn-primary">Create Key</button>
                </div>
            </form>
        </div>
    </div>
</div>

{{if .NewKey}}
<!-- New Key Display Modal -->
<div id="new-key-modal" class="modal">
    <div class="modal-content modal-lg">
        <div class="modal-header">
            <h3 class="modal-title">API Key Created Successfully</h3>
        </div>
        <div class="modal-body">
            <div class="alert alert-warning mb-4">
                <strong>Important:</strong> Copy this key now. You won't be able to see it again!
            </div>

            <div class="key-display mb-4">
                <label class="form-label">Your API Key</label>
                <div class="key-copy-container">
                    <code class="key-value" id="new-api-key">{{.NewKey}}</code>
                    <button type="button" class="btn btn-sm btn-secondary" onclick="copyToClipboard('new-api-key')">Copy</button>
                </div>
            </div>

            <div class="usage-examples">
                <h4 class="text-md font-semibold mb-3">How to Use Your Key</h4>

                <div class="example-tabs">
                    <button class="tab-btn active" onclick="showTab('curl')">cURL</button>
                    <button class="tab-btn" onclick="showTab('javascript')">JavaScript</button>
                    <button class="tab-btn" onclick="showTab('python')">Python</button>
                </div>

                <div id="tab-curl" class="tab-content active">
                    <pre class="code-block"><code>curl -H "X-API-Key: {{.NewKey}}" \
     http://localhost:8080/your-endpoint</code></pre>
                </div>

                <div id="tab-javascript" class="tab-content">
                    <pre class="code-block"><code>fetch('http://localhost:8080/your-endpoint', {
  headers: {
    'X-API-Key': '{{.NewKey}}'
  }
})
.then(res => res.json())
.then(data => console.log(data));</code></pre>
                </div>

                <div id="tab-python" class="tab-content">
                    <pre class="code-block"><code>import requests

response = requests.get(
    'http://localhost:8080/your-endpoint',
    headers={'X-API-Key': '{{.NewKey}}'}
)
print(response.json())</code></pre>
                </div>
            </div>

            <div class="form-actions mt-4">
                <button onclick="document.getElementById('new-key-modal').classList.add('hidden')" class="btn btn-primary">Got it, I've copied my key</button>
            </div>
        </div>
    </div>
</div>

<script>
function copyToClipboard(elementId) {
    const text = document.getElementById(elementId).textContent;
    navigator.clipboard.writeText(text).then(() => {
        const btn = event.target;
        btn.textContent = 'Copied!';
        setTimeout(() => btn.textContent = 'Copy', 2000);
    });
}

function showTab(tabName) {
    document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
    document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
    document.getElementById('tab-' + tabName).classList.add('active');
    event.target.classList.add('active');
}
</script>
{{end}}
{{end}}

{{define "panel-docs"}}
<div class="panel-section">
    <h3>API Keys</h3>
    <p>API keys authenticate requests to your gateway. Each key is tied to a user and inherits their plan's rate limits.</p>
</div>

<div class="panel-section">
    <h4>Key Management</h4>
    <ul class="panel-list">
        <li><strong>Create</strong> - Generate a new key for a user</li>
        <li><strong>Revoke</strong> - Disable a key permanently</li>
        <li><strong>Last Used</strong> - Track when keys are active</li>
    </ul>
</div>

<div class="panel-section">
    <h4>Using API Keys</h4>
    <p>Include the key in your request header:</p>
    <pre class="panel-code">X-API-Key: ak_your_key_here</pre>
</div>

<div class="panel-section">
    <h4>Security Tips</h4>
    <ul class="panel-list">
        <li>Never share keys in public repositories</li>
        <li>Rotate keys regularly</li>
        <li>Revoke compromised keys immediately</li>
    </ul>
</div>
{{end}}

{{define "panel-reference"}}
<div class="panel-section">
    <h3>Keys API</h3>
    <p>Manage API keys programmatically.</p>
</div>

<div class="panel-section">
    <h4>Create Key</h4>
    <pre class="panel-code">POST /mod/api_key
Content-Type: application/json

{
  "user_id": "user_id_here",
  "name": "My API Key"
}</pre>
</div>

<div class="panel-section">
    <h4>List Keys</h4>
    <pre class="panel-code">GET /mod/api_key</pre>
    <p class="text-muted">Returns all API keys with masked values.</p>
</div>

<div class="panel-section">
    <h4>Revoke Key</h4>
    <pre class="panel-code">DELETE /mod/api_key/{key_id}</pre>
    <p class="text-muted">Permanently disables the key.</p>
</div>
{{end}}
