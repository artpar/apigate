{{define "content"}}
<div class="page" style="max-width: 800px;">
    <div class="mb-4">
        <a href="/routes" class="link text-sm">&larr; Back to Routes</a>
    </div>
    <div class="page-header">
        <h1 class="page-title">{{if .IsNew}}Create Route{{else}}Edit Route{{end}}</h1>
    </div>

    <form action="{{if .IsNew}}/routes{{else}}/routes/{{.Route.ID}}{{end}}" method="POST" class="form">
        <!-- Basic Info -->
        <div class="card mb-4">
            <div class="card-header">Basic Information</div>
            <div class="card-body">
                <div class="form-group">
                    <label for="name" class="form-label">Name</label>
                    <input type="text" id="name" name="name" required class="form-input" placeholder="my-route" value="{{.Route.Name}}">
                </div>

                <div class="form-row">
                    <div class="form-group" style="flex: 2;">
                        <label for="path_pattern" class="form-label">Path Pattern</label>
                        <input type="text" id="path_pattern" name="path_pattern" required class="form-input" placeholder="/api/v1/*" value="{{.Route.PathPattern}}">
                        <div class="form-hint">Use * for wildcards, {param} for path parameters</div>
                    </div>
                    <div class="form-group" style="flex: 1;">
                        <label for="match_type" class="form-label">Match Type</label>
                        <select id="match_type" name="match_type" class="form-input">
                            <option value="exact" {{if eq .Route.MatchType "exact"}}selected{{end}}>Exact</option>
                            <option value="prefix" {{if eq .Route.MatchType "prefix"}}selected{{end}}>Prefix</option>
                            <option value="regex" {{if eq .Route.MatchType "regex"}}selected{{end}}>Regex</option>
                        </select>
                    </div>
                </div>

                <div class="form-group">
                    <label for="methods" class="form-label">Methods (comma-separated, empty = all)</label>
                    <input type="text" id="methods" name="methods" class="form-input" placeholder="GET, POST, PUT, DELETE" value="{{range $i, $m := .Route.Methods}}{{if $i}}, {{end}}{{$m}}{{end}}">
                </div>

                <div class="form-row">
                    <div class="form-group" style="flex: 1;">
                        <label for="priority" class="form-label">Priority</label>
                        <input type="number" id="priority" name="priority" class="form-input" value="{{.Route.Priority}}">
                        <div class="form-hint">Higher priority routes are matched first</div>
                    </div>
                    <div class="form-group" style="flex: 1;">
                        <label class="form-label">&nbsp;</label>
                        <label class="form-checkbox">
                            <input type="checkbox" name="enabled" {{if .Route.Enabled}}checked{{end}}>
                            <span>Enabled</span>
                        </label>
                    </div>
                </div>
            </div>
        </div>

        <!-- Upstream Configuration -->
        <div class="card mb-4">
            <div class="card-header">Upstream Configuration</div>
            <div class="card-body">
                <div class="form-group">
                    <label for="upstream_id" class="form-label">Target Upstream</label>
                    <select id="upstream_id" name="upstream_id" class="form-input">
                        <option value="">-- Select Upstream --</option>
                        {{range .Upstreams}}
                        <option value="{{.ID}}" {{if eq .ID $.Route.UpstreamID}}selected{{end}}>{{.Name}} ({{.BaseURL}})</option>
                        {{end}}
                    </select>
                </div>

                <div class="form-row">
                    <div class="form-group" style="flex: 2;">
                        <label for="path_rewrite" class="form-label">Path Rewrite (Expr)</label>
                        <input type="text" id="path_rewrite" name="path_rewrite" class="form-input" placeholder='"/v2" + trimPrefix(path, "/v1")' value="{{.Route.PathRewrite}}">
                        <div class="form-hint">Expression to transform the path</div>
                    </div>
                    <div class="form-group" style="flex: 1;">
                        <label for="method_override" class="form-label">Method Override</label>
                        <input type="text" id="method_override" name="method_override" class="form-input" placeholder="POST" value="{{.Route.MethodOverride}}">
                    </div>
                </div>

                <div class="form-group">
                    <label for="protocol" class="form-label">Protocol</label>
                    <select id="protocol" name="protocol" class="form-input">
                        <option value="http" {{if eq .Route.Protocol "http"}}selected{{end}}>HTTP (buffered)</option>
                        <option value="http_stream" {{if eq .Route.Protocol "http_stream"}}selected{{end}}>HTTP Stream (chunked)</option>
                        <option value="sse" {{if eq .Route.Protocol "sse"}}selected{{end}}>SSE (Server-Sent Events)</option>
                        <option value="websocket" {{if eq .Route.Protocol "websocket"}}selected{{end}}>WebSocket</option>
                    </select>
                </div>
            </div>
        </div>

        <!-- Metering -->
        <div class="card mb-4">
            <div class="card-header">Usage Metering</div>
            <div class="card-body">
                <div class="form-row">
                    <div class="form-group" style="flex: 1;">
                        <label for="metering_mode" class="form-label">Mode</label>
                        <select id="metering_mode" name="metering_mode" class="form-input">
                            <option value="request" {{if eq .Route.MeteringMode "request"}}selected{{end}}>Per Request (count=1)</option>
                            <option value="response_field" {{if eq .Route.MeteringMode "response_field"}}selected{{end}}>Response Field</option>
                            <option value="bytes" {{if eq .Route.MeteringMode "bytes"}}selected{{end}}>Response Bytes</option>
                            <option value="custom" {{if eq .Route.MeteringMode "custom"}}selected{{end}}>Custom Expression</option>
                        </select>
                    </div>
                    <div class="form-group" style="flex: 2;">
                        <label for="metering_expr" class="form-label">Metering Expression</label>
                        <input type="text" id="metering_expr" name="metering_expr" class="form-input" placeholder='respBody.usage.total_tokens ?? 1' value="{{.Route.MeteringExpr}}">
                        <div class="form-hint">Expr to extract usage value from response</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Request Transform -->
        <div class="card mb-4">
            <div class="card-header">Request Transform</div>
            <div class="card-body">
                <div class="form-group">
                    <label for="request_set_headers" class="form-label">Set Headers (one per line: Header-Name=Expr)</label>
                    <textarea id="request_set_headers" name="request_set_headers" class="form-input" rows="3" placeholder='X-Custom-Header="value"&#10;Authorization="Bearer " + env("API_KEY")'>{{range $k, $v := .Route.RequestTransform.SetHeaders}}{{$k}}={{$v}}
{{end}}</textarea>
                </div>
                <div class="form-group">
                    <label for="request_delete_headers" class="form-label">Delete Headers (comma-separated)</label>
                    <input type="text" id="request_delete_headers" name="request_delete_headers" class="form-input" placeholder="X-Remove-This, X-And-This" value="{{range $i, $h := .Route.RequestTransform.DeleteHeaders}}{{if $i}}, {{end}}{{$h}}{{end}}">
                </div>
                <div class="form-group">
                    <label for="request_set_query" class="form-label">Set Query Params (one per line: param=Expr)</label>
                    <textarea id="request_set_query" name="request_set_query" class="form-input" rows="2" placeholder='api_key=env("API_KEY")'>{{range $k, $v := .Route.RequestTransform.SetQuery}}{{$k}}={{$v}}
{{end}}</textarea>
                </div>
                <div class="form-group">
                    <label for="request_body_expr" class="form-label">Body Transform (Expr returning JSON)</label>
                    <textarea id="request_body_expr" name="request_body_expr" class="form-input" rows="3" placeholder='{"wrapped": body, "extra": "added"}'>{{if .Route.RequestTransform}}{{.Route.RequestTransform.BodyExpr}}{{end}}</textarea>
                </div>
            </div>
        </div>

        <!-- Response Transform -->
        <div class="card mb-4">
            <div class="card-header">Response Transform</div>
            <div class="card-body">
                <div class="form-group">
                    <label for="response_set_headers" class="form-label">Set Headers (one per line: Header-Name=Expr)</label>
                    <textarea id="response_set_headers" name="response_set_headers" class="form-input" rows="2" placeholder='X-Response-ID=uuid()'>{{range $k, $v := .Route.ResponseTransform.SetHeaders}}{{$k}}={{$v}}
{{end}}</textarea>
                </div>
                <div class="form-group">
                    <label for="response_delete_headers" class="form-label">Delete Headers (comma-separated)</label>
                    <input type="text" id="response_delete_headers" name="response_delete_headers" class="form-input" placeholder="X-Internal-Header" value="{{range $i, $h := .Route.ResponseTransform.DeleteHeaders}}{{if $i}}, {{end}}{{$h}}{{end}}">
                </div>
                <div class="form-group">
                    <label for="response_body_expr" class="form-label">Body Transform (Expr returning JSON)</label>
                    <textarea id="response_body_expr" name="response_body_expr" class="form-input" rows="3" placeholder='{"success": status < 400, "data": respBody}'>{{if .Route.ResponseTransform}}{{.Route.ResponseTransform.BodyExpr}}{{end}}</textarea>
                </div>
            </div>
        </div>

        <div class="form-actions">
            <a href="/routes" class="btn btn-secondary">Cancel</a>
            <button type="submit" class="btn btn-primary">{{if .IsNew}}Create Route{{else}}Update Route{{end}}</button>
        </div>
    </form>
</div>
{{end}}
